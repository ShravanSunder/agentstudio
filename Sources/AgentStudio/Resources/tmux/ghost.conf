# Ghost tmux — invisible session daemon for Agent Studio
# Minimal config: let Ghostty handle all terminal features (mouse, focus, resize).
# tmux only provides PTY persistence across app restarts.
# tmux must be completely headless: no status bar, no copy-mode, no overlays.
# All mouse/scroll events pass through tmux to programs running inside.

# No prefix key — tmux won't intercept any keystrokes
set -g prefix None

# No visual chrome
set -g status off

# ─── Terminal identity ───────────────────────────────────────────────
# Use xterm-256color (our custom build with full Ghostty capabilities),
# NOT xterm-ghostty. When tmux detects xterm-ghostty it enables Kitty
# keyboard protocol handling that conflicts with GhosttyKit's own
# keyboard input, causing every keystroke to be doubled.
# See: https://github.com/ghostty-org/ghostty/issues/3335
#
# Our custom xterm-256color terminfo (Resources/terminfo/78/xterm-256color)
# includes: RGB/Tc true color, Smulx styled underlines, Setulc underline
# colors, Sync synchronized output, SGR mouse (kmous=\E[<), XM, bracketed
# paste (BD/BE). Programs inside tmux get full Ghostty visual capabilities
# without the Kitty keyboard protocol conflict.
set -g default-terminal "xterm-256color"

# ─── Outer terminal overrides ────────────────────────────────────────
# These override what tmux thinks the OUTER terminal (xterm-ghostty) can do.
# We tell tmux the outer terminal has RGB but strip nothing else — Ghostty
# handles all capabilities natively.
# Fallback: if GHOSTTY_RESOURCES_DIR fails and outer TERM is xterm-256color,
# these overrides still provide RGB.
set -as terminal-overrides ",xterm-ghostty:RGB"
set -as terminal-overrides ",xterm-256color:RGB"

# ─── Disable alternate screen on outer terminal ───────────────────────
# Remove smcup/rmcup so tmux does NOT enter alternate screen mode.
# Without alternate screen, Ghostty's mouse_alternate_scroll mode (DEC 1007,
# default ON) won't trigger — Ghostty handles scroll as internal viewport
# scrollback instead of converting scroll to cursor keys sent to tmux.
# This is safe for headless tmux: no status bar, single pane, no visual
# chrome that depends on alternate screen.
set -as terminal-overrides ",xterm-ghostty:smcup@:rmcup@"
set -as terminal-overrides ",xterm-256color:smcup@:rmcup@"
set -as terminal-overrides ',xterm-256color:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',xterm-256color:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# Explicitly disable extended keys to prevent keyboard protocol conflicts
# between tmux and GhosttyKit's native keyboard handling.
set -g extended-keys off

# ─── Headless mouse configuration ────────────────────────────────────
# Disable tmux's own mouse handling entirely. With mouse off, tmux does
# NOT intercept mouse events for its own UI (copy-mode, pane selection,
# resize). Mouse events still pass through to programs inside tmux that
# request mouse reporting (vim, etc.) via the normal terminal protocol.
set -g mouse off

# ─── Remove problematic tmux keybindings ─────────────────────────────
# Do NOT use `unbind -a` here — it empties/destroys key tables, causing
# "table doesn't exist" errors when buildAttachCommand's inline hardening
# runs `unbind-key -a -T <table>`. Those errors display as view-mode in
# the first pane. The inline hardening handles broad unbinding at attach time.
#
# Belt-and-suspenders: explicitly unbind mouse/scroll events that can
# trigger copy-mode. Individual unbinds are safe even if the key doesn't
# exist — they silently succeed without destroying the table.
unbind -T root WheelUpPane
unbind -T root WheelDownPane
unbind -T root MouseDown1Pane
unbind -T root MouseDrag1Pane
unbind -T copy-mode WheelUpPane
unbind -T copy-mode WheelDownPane
unbind -T copy-mode-vi WheelUpPane
unbind -T copy-mode-vi WheelDownPane

# tmux 3.6+ scrollbar default bindings — these enter copy-mode on scrollbar
# click/drag and are re-created by key_bindings_init() at server start.
unbind -T root MouseDown1ScrollbarUp
unbind -T root MouseDown1ScrollbarDown
unbind -T root MouseDrag1ScrollbarSlider

# No escape delay — immediate key processing
set -g escape-time 0

# Large scrollback for session persistence
set -g history-limit 50000

# Keep sessions alive when last client detaches
set -g destroy-unattached off
set -g exit-unattached off

# Unset TMUX so user can run their own tmux inside ghost sessions
set-environment -g -u TMUX

# Unset CLAUDECODE so Claude Code can be launched inside ghost sessions.
# Without this, sessions inherit the variable from the parent process
# and Claude Code refuses to start ("nested session" guard).
set-environment -g -u CLAUDECODE
