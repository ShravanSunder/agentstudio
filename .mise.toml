[tools]
zig = "0.15.2"

[env]
PROJECT_ROOT = "{{config_root}}"

# --- Low-level build tasks ---

[tasks.build-ghostty]
description = "Build Ghostty XCFramework"
run = "zig build -Doptimize=ReleaseFast -Demit-xcframework=true -Demit-macos-app=false -Dxcframework-target=native"
dir = "vendor/ghostty"

[tasks.build-zmx]
description = "Build zmx session multiplexer"
run = "zig build -Doptimize=ReleaseFast"
dir = "vendor/zmx"

[tasks.copy-xcframework]
description = "Copy GhosttyKit.xcframework to Frameworks/"
depends = ["build-ghostty"]
run = """
if [ -d "Frameworks/GhosttyKit.xcframework" ]; then
  echo "GhosttyKit.xcframework already exists, skipping copy (use mise run clean to force)"
  exit 0
fi
mkdir -p Frameworks
cp -R vendor/ghostty/macos/GhosttyKit.xcframework Frameworks/
"""

[tasks.setup-dev-resources]
description = "Copy shell-integration and terminfo for SPM resource bundling"
depends = ["build-ghostty"]
run = """
#!/usr/bin/env bash
set -e

# --- Shell Integration ---
SHELL_INTEGRATION_ZIG="vendor/ghostty/zig-out/share/ghostty/shell-integration"
SHELL_INTEGRATION_VENDOR="vendor/ghostty/src/shell-integration"
SHELL_INTEGRATION_DEV="Sources/AgentStudio/Resources/ghostty/shell-integration"

if [ -d "$SHELL_INTEGRATION_ZIG" ]; then
  SRC="$SHELL_INTEGRATION_ZIG"
elif [ -d "$SHELL_INTEGRATION_VENDOR" ]; then
  SRC="$SHELL_INTEGRATION_VENDOR"
else
  echo "ERROR: shell-integration not found" && exit 1
fi

if [ -d "$SHELL_INTEGRATION_DEV" ]; then
  echo "shell-integration already exists, skipping copy (use mise run clean to force)"
else
  mkdir -p "$(dirname "$SHELL_INTEGRATION_DEV")"
  cp -R "$SRC" "$SHELL_INTEGRATION_DEV"
  echo "shell-integration -> $SHELL_INTEGRATION_DEV"
fi

# --- Terminfo (Ghostty entries only, preserve custom xterm-256color) ---
TERMINFO_SRC="vendor/ghostty/zig-out/share/terminfo"
TERMINFO_DEV="Sources/AgentStudio/Resources/terminfo"
if [ -d "$TERMINFO_DEV/78" ] && [ -d "$TERMINFO_DEV/67" ]; then
  echo "terminfo already exists, skipping copy (use mise run clean to force)"
elif [ -d "$TERMINFO_SRC" ]; then
  mkdir -p "$TERMINFO_DEV/78" "$TERMINFO_DEV/67"
  [ -f "$TERMINFO_SRC/78/xterm-ghostty" ] && cp "$TERMINFO_SRC/78/xterm-ghostty" "$TERMINFO_DEV/78/"
  [ -f "$TERMINFO_SRC/67/ghostty" ] && cp "$TERMINFO_SRC/67/ghostty" "$TERMINFO_DEV/67/"
  echo "terminfo updated (custom xterm-256color preserved)"
fi
"""

# --- Format & lint tasks ---

[tasks.format]
description = "Format Swift sources with swift-format"
run = """
swift-format format --in-place --recursive Sources/ Tests/
echo "Formatted all Swift sources"
"""

[tasks.lint]
description = "Lint Swift sources with swift-format and swiftlint"
run = """
#!/usr/bin/env bash
set -e
echo "--- swift-format lint ---"
swift-format lint --recursive Sources/ Tests/ 2>&1 && echo "swift-format: OK" || { echo "swift-format: FAIL"; exit 1; }
echo "--- swiftlint ---"
swiftlint lint --strict 2>&1 && echo "swiftlint: OK" || { echo "swiftlint: FAIL"; exit 1; }
echo "--- architecture boundary checks ---"
bash scripts/check-core-boundary-imports.sh
"""

# --- Setup (first-time / after clean) ---

[tasks.setup]
description = "First-time setup: build zig deps, copy frameworks and resources"
depends = ["copy-xcframework", "setup-dev-resources", "build-zmx"]
run = "echo 'Setup complete. Run mise run build or mise run test.'"

# --- Composite build tasks ---

[tasks.build]
description = "Debug build (run mise run setup first time)"
run = "swift build"

[tasks.build-release]
description = "Release build (run mise run setup first time)"
run = "swift build -c release"

[tasks.test]
description = "Run default test suite (excludes E2E + ZmxE2E by default)"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -euo pipefail
BUILD_PATH="${SWIFT_BUILD_DIR:-.build}"
if [ "${SWIFT_TEST_PARALLEL:-1}" = "1" ]; then
  SWIFT_TEST_WORKERS="${SWIFT_TEST_WORKERS:-$(( $(sysctl -n hw.ncpu) / 2 ))}"
  if [ "$SWIFT_TEST_WORKERS" -lt 2 ]; then SWIFT_TEST_WORKERS=2; fi
  if [ "$SWIFT_TEST_WORKERS" -gt 4 ]; then SWIFT_TEST_WORKERS=4; fi
  AGENT_STUDIO_BENCHMARK_MODE=off swift test --parallel --num-workers "$SWIFT_TEST_WORKERS" --skip WebKitSerializedTests --skip E2ESerializedTests --skip ZmxE2ETests --build-path "$BUILD_PATH"
else
  AGENT_STUDIO_BENCHMARK_MODE=off swift test --skip WebKitSerializedTests --skip E2ESerializedTests --skip ZmxE2ETests --build-path "$BUILD_PATH"
fi
echo "--- WebView serialized tests (serial) ---"
run_webkit_suite_with_retry() {
  local filter="$1"
  local attempt=1
  local max_attempts=3
  local backoff_seconds=1

  while [ "$attempt" -le "$max_attempts" ]; do
    echo "[webkit] running $filter (attempt $attempt/$max_attempts)"
    set +e
    local output
    output=$(AGENT_STUDIO_BENCHMARK_MODE=off swift test --filter "$filter" --build-path "$BUILD_PATH" 2>&1)
    local status=$?
    set -e
    echo "$output"

    if [ "$status" -eq 0 ]; then
      return 0
    fi

    if echo "$output" | grep -q "unexpected signal code 5"; then
      if [ "$attempt" -lt "$max_attempts" ]; then
        echo "[webkit] signal 5 in $filter; retrying after ${backoff_seconds}s"
        sleep "$backoff_seconds"
        backoff_seconds=$((backoff_seconds * 2))
        attempt=$((attempt + 1))
        continue
      fi
    fi

    return "$status"
  done
}

run_webkit_suite_with_retry "WebKitSerializedTests/BridgePaneControllerTests"
run_webkit_suite_with_retry "WebKitSerializedTests/BridgeSchemeHandlerSpikeTests"
run_webkit_suite_with_retry "WebKitSerializedTests/BridgeTransportIntegrationTests"
run_webkit_suite_with_retry "WebKitSerializedTests/BridgeWebKitSpikeTests"
echo "--- E2E serialized tests (serial) ---"
if [ "${SWIFT_TEST_INCLUDE_E2E:-0}" = "1" ]; then
  AGENT_STUDIO_BENCHMARK_MODE=off swift test --filter E2ESerializedTests --build-path "$BUILD_PATH"
else
  echo "[test] skipping E2ESerializedTests (SWIFT_TEST_INCLUDE_E2E=${SWIFT_TEST_INCLUDE_E2E:-0})"
fi
echo "--- Zmx E2E tests (serial) ---"
if [ "${SWIFT_TEST_INCLUDE_ZMX_E2E:-0}" = "1" ]; then
  AGENT_STUDIO_BENCHMARK_MODE=off swift test --filter ZmxE2ETests --build-path "$BUILD_PATH"
else
  echo "[test] skipping ZmxE2ETests (SWIFT_TEST_INCLUDE_ZMX_E2E=${SWIFT_TEST_INCLUDE_ZMX_E2E:-0})"
fi
"""

[tasks.test-e2e]
description = "Run E2E serialized tests only (opt-in; zmx E2E currently unstable)"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -euo pipefail
BUILD_PATH="${SWIFT_BUILD_DIR:-.build}"
AGENT_STUDIO_BENCHMARK_MODE=off swift test --filter E2ESerializedTests --build-path "$BUILD_PATH"
"""

[tasks.test-zmx-e2e]
description = "Run zmx E2E tests only (opt-in; may stall)"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -euo pipefail
BUILD_PATH="${SWIFT_BUILD_DIR:-.build}"
AGENT_STUDIO_BENCHMARK_MODE=off swift test --filter ZmxE2ETests --build-path "$BUILD_PATH"
"""

[tasks.test-benchmark]
description = "Run benchmark-only bridge push tests"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -euo pipefail
BUILD_PATH="${SWIFT_BUILD_DIR:-.build}"
export AGENT_STUDIO_BENCHMARK_MODE=benchmark

swift test --build-path "$BUILD_PATH" --filter "PushBenchmarkSupportTests"
swift test --build-path "$BUILD_PATH" --filter "PushPerformanceBenchmarkTests"
"""

[tasks.clean]
description = "Clean all build artifacts"
run = """
rm -rf .build Frameworks/GhosttyKit.xcframework AgentStudio.app
rm -rf Sources/AgentStudio/Resources/ghostty
rm -rf vendor/ghostty/.zig-cache vendor/ghostty/zig-out vendor/ghostty/macos/build vendor/ghostty/macos/*.xcframework
rm -rf vendor/zmx/.zig-cache vendor/zmx/zig-out
echo "Cleaned all build artifacts"
"""

[tasks.create-app-bundle]
description = "Create signed AgentStudio.app bundle"
depends = ["build-release"]
run = """
#!/usr/bin/env bash
set -e

APP_DIR="AgentStudio.app/Contents"
rm -rf AgentStudio.app
mkdir -p "$APP_DIR/MacOS" "$APP_DIR/Resources" "$APP_DIR/Frameworks"

# Binary
cp .build/release/AgentStudio "$APP_DIR/MacOS/"

# zmx
[ -f "vendor/zmx/zig-out/bin/zmx" ] && cp vendor/zmx/zig-out/bin/zmx "$APP_DIR/MacOS/"

# Info.plist + icon
cp Sources/AgentStudio/Resources/Info.plist "$APP_DIR/"
cp Sources/AgentStudio/Resources/AppIcon.icns "$APP_DIR/Resources/"

# terminfo
TERMINFO="Sources/AgentStudio/Resources/terminfo"
[ -d "$TERMINFO" ] && cp -R "$TERMINFO" "$APP_DIR/Resources/"

# shell-integration
GHOSTTY_RES="Sources/AgentStudio/Resources/ghostty"
[ -d "$GHOSTTY_RES" ] && { mkdir -p "$APP_DIR/Resources/ghostty"; cp -R "$GHOSTTY_RES/." "$APP_DIR/Resources/ghostty/"; }

# GhosttyKit framework
cp -R Frameworks/GhosttyKit.xcframework "$APP_DIR/Frameworks/"

# Sign
codesign --force --deep --sign - AgentStudio.app
echo "AgentStudio.app created and signed"
"""
