[tools]
zig = "0.15.2"

[env]
PROJECT_ROOT = "{{config_root}}"

# --- Low-level build tasks ---

[tasks.build-ghostty]
description = "Build Ghostty XCFramework"
run = "zig build -Doptimize=ReleaseFast -Demit-xcframework=true -Demit-macos-app=false -Dxcframework-target=native"
dir = "vendor/ghostty"

[tasks.build-zmx]
description = "Build zmx session multiplexer"
run = "zig build -Doptimize=ReleaseFast"
dir = "vendor/zmx"

[tasks.copy-xcframework]
description = "Copy GhosttyKit.xcframework to Frameworks/"
depends = ["build-ghostty"]
run = """
if [ -d "Frameworks/GhosttyKit.xcframework" ]; then
  echo "GhosttyKit.xcframework already exists, skipping copy (use mise run clean to force)"
  exit 0
fi
mkdir -p Frameworks
cp -R vendor/ghostty/macos/GhosttyKit.xcframework Frameworks/
"""

[tasks.setup-dev-resources]
description = "Copy shell-integration and terminfo for SPM resource bundling"
depends = ["build-ghostty"]
run = """
#!/usr/bin/env bash
set -e

# --- Shell Integration ---
SHELL_INTEGRATION_ZIG="vendor/ghostty/zig-out/share/ghostty/shell-integration"
SHELL_INTEGRATION_VENDOR="vendor/ghostty/src/shell-integration"
SHELL_INTEGRATION_DEV="Sources/AgentStudio/Resources/ghostty/shell-integration"

if [ -d "$SHELL_INTEGRATION_ZIG" ]; then
  SRC="$SHELL_INTEGRATION_ZIG"
elif [ -d "$SHELL_INTEGRATION_VENDOR" ]; then
  SRC="$SHELL_INTEGRATION_VENDOR"
else
  echo "ERROR: shell-integration not found" && exit 1
fi

if [ -d "$SHELL_INTEGRATION_DEV" ]; then
  echo "shell-integration already exists, skipping copy (use mise run clean to force)"
else
  mkdir -p "$(dirname "$SHELL_INTEGRATION_DEV")"
  cp -R "$SRC" "$SHELL_INTEGRATION_DEV"
  echo "shell-integration -> $SHELL_INTEGRATION_DEV"
fi

# --- Terminfo (Ghostty entries only, preserve custom xterm-256color) ---
TERMINFO_SRC="vendor/ghostty/zig-out/share/terminfo"
TERMINFO_DEV="Sources/AgentStudio/Resources/terminfo"
if [ -d "$TERMINFO_DEV/78" ] && [ -d "$TERMINFO_DEV/67" ]; then
  echo "terminfo already exists, skipping copy (use mise run clean to force)"
elif [ -d "$TERMINFO_SRC" ]; then
  mkdir -p "$TERMINFO_DEV/78" "$TERMINFO_DEV/67"
  [ -f "$TERMINFO_SRC/78/xterm-ghostty" ] && cp "$TERMINFO_SRC/78/xterm-ghostty" "$TERMINFO_DEV/78/"
  [ -f "$TERMINFO_SRC/67/ghostty" ] && cp "$TERMINFO_SRC/67/ghostty" "$TERMINFO_DEV/67/"
  echo "terminfo updated (custom xterm-256color preserved)"
fi
"""

# --- Format & lint tasks ---

[tasks.format]
description = "Format Swift sources with swift-format"
run = """
swift-format format --in-place --recursive Sources/ Tests/
echo "Formatted all Swift sources"
"""

[tasks.lint]
description = "Lint Swift sources with swift-format and swiftlint"
run = """
#!/usr/bin/env bash
set -e
echo "--- swift-format lint ---"
swift-format lint --recursive Sources/ Tests/ 2>&1 && echo "swift-format: OK" || { echo "swift-format: FAIL"; exit 1; }
echo "--- swiftlint ---"
swiftlint lint --strict 2>&1 && echo "swiftlint: OK" || { echo "swiftlint: FAIL"; exit 1; }
echo "--- architecture boundary checks ---"
bash scripts/check-core-boundary-imports.sh
"""

# --- Setup (first-time / after clean) ---

[tasks.setup]
description = "First-time setup: build zig deps, copy frameworks and resources"
depends = ["copy-xcframework", "setup-dev-resources", "build-zmx"]
run = "echo 'Setup complete. Run mise run build or mise run test.'"

# --- Composite build tasks ---

[tasks.build]
description = "Debug build (run mise run setup first time)"
run = """
#!/usr/bin/env bash
set -euo pipefail
RUN_ID="${AGENT_RUN_ID:-}"
if [ -z "$RUN_ID" ]; then
  echo "[build] ERROR: AGENT_RUN_ID is required (example: AGENT_RUN_ID=abc123 mise run build)"
  exit 2
fi
BUILD_PATH="${SWIFT_BUILD_DIR:-.build-agent-$RUN_ID}"
echo "[build] BUILD_PATH=$BUILD_PATH"
swift build --build-path "$BUILD_PATH"
"""

[tasks.build-release]
description = "Release build (run mise run setup first time)"
run = """
#!/usr/bin/env bash
set -euo pipefail
RUN_ID="${AGENT_RUN_ID:-}"
if [ -z "$RUN_ID" ]; then
  echo "[build-release] ERROR: AGENT_RUN_ID is required (example: AGENT_RUN_ID=abc123 mise run build-release)"
  exit 2
fi
BUILD_PATH="${SWIFT_BUILD_DIR:-.build-release-agent-$RUN_ID}"
echo "[build-release] BUILD_PATH=$BUILD_PATH"
swift build -c release --build-path "$BUILD_PATH"
"""

[tasks.test]
description = "Run default test suite (excludes E2E + ZmxE2E by default)"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -euo pipefail
RUN_ID="${AGENT_RUN_ID:-}"
if [ -z "$RUN_ID" ]; then
  echo "[test] ERROR: AGENT_RUN_ID is required (example: AGENT_RUN_ID=abc123 mise run test)"
  exit 2
fi
BUILD_PATH="${SWIFT_BUILD_DIR:-.build-agent-$RUN_ID}"
TIMEOUT_SECONDS="${SWIFT_TEST_TIMEOUT_SECONDS:-60}"
echo "[test] BUILD_PATH=$BUILD_PATH"
echo "[test] TIMEOUT_SECONDS=$TIMEOUT_SECONDS"

run_swift_with_timeout() {
  local label="$1"
  shift
  local timeout_seconds="$1"
  shift

  echo "[test] >>> $label (timeout=${timeout_seconds}s)"
  local start_epoch
  start_epoch=$(date +%s)
  local last_heartbeat="$start_epoch"
  local timed_out=0

  "$@" &
  local command_pid=$!

  while kill -0 "$command_pid" 2>/dev/null; do
    sleep 1
    local now_epoch
    now_epoch=$(date +%s)
    local elapsed_seconds=$((now_epoch - start_epoch))

    if [ "$elapsed_seconds" -ge "$timeout_seconds" ]; then
      timed_out=1
      break
    fi

    if [ $((now_epoch - last_heartbeat)) -ge 20 ]; then
      echo "[test] ... $label still running (${elapsed_seconds}s)"
      last_heartbeat="$now_epoch"
    fi
  done

  if [ "$timed_out" -eq 1 ]; then
    echo "[test] ERROR: timeout while running '$label' after ${timeout_seconds}s"
    kill -TERM "$command_pid" 2>/dev/null || true
    sleep 2
    kill -KILL "$command_pid" 2>/dev/null || true
    pkill -9 -f "swiftpm-testing-helper|swift test|swift-build|AgentStudioPackageTests" || true
    wait "$command_pid" 2>/dev/null || true
    return 124
  fi

  set +e
  wait "$command_pid"
  local command_status=$?
  set -e

  return "$command_status"
}

if [ "${SWIFT_TEST_PARALLEL:-1}" = "1" ]; then
  SWIFT_TEST_WORKERS="${SWIFT_TEST_WORKERS:-$(( $(sysctl -n hw.ncpu) / 2 ))}"
  if [ "$SWIFT_TEST_WORKERS" -lt 2 ]; then SWIFT_TEST_WORKERS=2; fi
  if [ "$SWIFT_TEST_WORKERS" -gt 4 ]; then SWIFT_TEST_WORKERS=4; fi
  run_swift_with_timeout \
    "parallel non-serialized suites" \
    "$TIMEOUT_SECONDS" \
    env AGENT_STUDIO_BENCHMARK_MODE=off swift test --parallel --num-workers "$SWIFT_TEST_WORKERS" \
    --skip WebKitSerializedTests --skip E2ESerializedTests --skip ZmxE2ETests --build-path "$BUILD_PATH"
else
  run_swift_with_timeout \
    "serial non-serialized suites" \
    "$TIMEOUT_SECONDS" \
    env AGENT_STUDIO_BENCHMARK_MODE=off swift test \
    --skip WebKitSerializedTests --skip E2ESerializedTests --skip ZmxE2ETests --build-path "$BUILD_PATH"
fi

echo "--- WebView serialized tests (serial) ---"
run_webkit_suite_with_retry() {
  local filter="$1"
  local attempt=1
  local max_attempts=3
  local backoff_seconds=1

  while [ "$attempt" -le "$max_attempts" ]; do
    echo "[webkit] running $filter (attempt $attempt/$max_attempts)"
    set +e
    local output
    output=$(run_swift_with_timeout "$filter" "$TIMEOUT_SECONDS" env AGENT_STUDIO_BENCHMARK_MODE=off swift test --filter "$filter" --build-path "$BUILD_PATH" 2>&1)
    local command_status=$?
    set -e
    echo "$output"

    if [ "$command_status" -eq 0 ]; then
      return 0
    fi
    if [ "$command_status" -eq 124 ]; then
      return 124
    fi

    if [ "$command_status" -ne 124 ] && echo "$output" | grep -Eq "unexpected signal code [0-9]+"; then
      local signal_code
      signal_code=$(echo "$output" | grep -Eo "unexpected signal code [0-9]+" | grep -Eo "[0-9]+" | tail -n 1)
      if [ -z "$signal_code" ]; then
        signal_code="unknown"
      fi
      if [ "$attempt" -lt "$max_attempts" ]; then
        echo "[webkit] signal $signal_code in $filter; retrying after ${backoff_seconds}s"
        sleep "$backoff_seconds"
        backoff_seconds=$((backoff_seconds * 2))
        attempt=$((attempt + 1))
        continue
      fi
    fi

    return "$command_status"
  done
}

run_webkit_suite_with_retry "WebKitSerializedTests/BridgePaneControllerTests"
run_webkit_suite_with_retry "WebKitSerializedTests/BridgeSchemeHandlerSpikeTests"
run_webkit_suite_with_retry "WebKitSerializedTests/BridgeTransportIntegrationTests"
run_webkit_suite_with_retry "WebKitSerializedTests/BridgeWebKitSpikeTests"
echo "--- E2E serialized tests (serial) ---"
if [ "${SWIFT_TEST_INCLUDE_E2E:-0}" = "1" ]; then
  run_swift_with_timeout \
    "E2ESerializedTests" \
    "$TIMEOUT_SECONDS" \
    env AGENT_STUDIO_BENCHMARK_MODE=off swift test --filter E2ESerializedTests --build-path "$BUILD_PATH"
else
  echo "[test] skipping E2ESerializedTests (SWIFT_TEST_INCLUDE_E2E=${SWIFT_TEST_INCLUDE_E2E:-0})"
fi
echo "--- Zmx E2E tests (serial) ---"
if [ "${SWIFT_TEST_INCLUDE_ZMX_E2E:-0}" = "1" ]; then
  run_swift_with_timeout \
    "ZmxE2ETests" \
    "$TIMEOUT_SECONDS" \
    env AGENT_STUDIO_BENCHMARK_MODE=off swift test --filter ZmxE2ETests --build-path "$BUILD_PATH"
else
  echo "[test] skipping ZmxE2ETests (SWIFT_TEST_INCLUDE_ZMX_E2E=${SWIFT_TEST_INCLUDE_ZMX_E2E:-0})"
fi
"""

[tasks.test-coverage]
description = "Run test suite with code coverage and print coverage JSON path"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -euo pipefail
RUN_ID="${AGENT_RUN_ID:-}"
if [ -z "$RUN_ID" ]; then
  echo "[test-coverage] ERROR: AGENT_RUN_ID is required (example: AGENT_RUN_ID=abc123 mise run test-coverage)"
  exit 2
fi
BUILD_PATH="${SWIFT_BUILD_DIR:-.build-agent-$RUN_ID}"
TIMEOUT_SECONDS="${SWIFT_TEST_TIMEOUT_SECONDS:-60}"
echo "[test-coverage] BUILD_PATH=$BUILD_PATH"
echo "[test-coverage] TIMEOUT_SECONDS=$TIMEOUT_SECONDS"

run_swift_with_timeout() {
  local label="$1"
  shift
  local timeout_seconds="$1"
  shift

  echo "[test-coverage] >>> $label (timeout=${timeout_seconds}s)"
  local start_epoch
  start_epoch=$(date +%s)
  local last_heartbeat="$start_epoch"
  local timed_out=0

  "$@" &
  local command_pid=$!

  while kill -0 "$command_pid" 2>/dev/null; do
    sleep 1
    local now_epoch
    now_epoch=$(date +%s)
    local elapsed_seconds=$((now_epoch - start_epoch))

    if [ "$elapsed_seconds" -ge "$timeout_seconds" ]; then
      timed_out=1
      break
    fi

    if [ $((now_epoch - last_heartbeat)) -ge 20 ]; then
      echo "[test-coverage] ... $label still running (${elapsed_seconds}s)"
      last_heartbeat="$now_epoch"
    fi
  done

  if [ "$timed_out" -eq 1 ]; then
    echo "[test-coverage] ERROR: timeout while running '$label' after ${timeout_seconds}s"
    kill -TERM "$command_pid" 2>/dev/null || true
    sleep 2
    kill -KILL "$command_pid" 2>/dev/null || true
    pkill -9 -f "swiftpm-testing-helper|swift test|swift-build|AgentStudioPackageTests" || true
    wait "$command_pid" 2>/dev/null || true
    return 124
  fi

  set +e
  wait "$command_pid"
  local command_status=$?
  set -e

  return "$command_status"
}

if [ "${SWIFT_TEST_PARALLEL:-1}" = "1" ]; then
  SWIFT_TEST_WORKERS="${SWIFT_TEST_WORKERS:-$(( $(sysctl -n hw.ncpu) / 2 ))}"
  if [ "$SWIFT_TEST_WORKERS" -lt 2 ]; then SWIFT_TEST_WORKERS=2; fi
  if [ "$SWIFT_TEST_WORKERS" -gt 4 ]; then SWIFT_TEST_WORKERS=4; fi
  run_swift_with_timeout \
    "parallel non-serialized suites (coverage)" \
    "$TIMEOUT_SECONDS" \
    env AGENT_STUDIO_BENCHMARK_MODE=off swift test --enable-code-coverage --parallel --num-workers "$SWIFT_TEST_WORKERS" \
    --skip WebKitSerializedTests --skip E2ESerializedTests --skip ZmxE2ETests --build-path "$BUILD_PATH"
else
  run_swift_with_timeout \
    "serial non-serialized suites (coverage)" \
    "$TIMEOUT_SECONDS" \
    env AGENT_STUDIO_BENCHMARK_MODE=off swift test --enable-code-coverage \
    --skip WebKitSerializedTests --skip E2ESerializedTests --skip ZmxE2ETests --build-path "$BUILD_PATH"
fi

echo "--- WebView serialized tests (serial, coverage) ---"
run_webkit_suite_with_retry() {
  local filter="$1"
  local attempt=1
  local max_attempts=3
  local backoff_seconds=1

  while [ "$attempt" -le "$max_attempts" ]; do
    echo "[webkit] running $filter (attempt $attempt/$max_attempts)"
    set +e
    local output
    output=$(run_swift_with_timeout "$filter (coverage)" "$TIMEOUT_SECONDS" env AGENT_STUDIO_BENCHMARK_MODE=off swift test --enable-code-coverage --filter "$filter" --build-path "$BUILD_PATH" 2>&1)
    local command_status=$?
    set -e
    echo "$output"

    if [ "$command_status" -eq 0 ]; then
      return 0
    fi
    if [ "$command_status" -eq 124 ]; then
      return 124
    fi

    if [ "$command_status" -ne 124 ] && echo "$output" | grep -Eq "unexpected signal code [0-9]+"; then
      local signal_code
      signal_code=$(echo "$output" | grep -Eo "unexpected signal code [0-9]+" | grep -Eo "[0-9]+" | tail -n 1)
      if [ -z "$signal_code" ]; then
        signal_code="unknown"
      fi
      if [ "$attempt" -lt "$max_attempts" ]; then
        echo "[webkit] signal $signal_code in $filter; retrying after ${backoff_seconds}s"
        sleep "$backoff_seconds"
        backoff_seconds=$((backoff_seconds * 2))
        attempt=$((attempt + 1))
        continue
      fi
    fi

    return "$command_status"
  done
}

run_webkit_suite_with_retry "WebKitSerializedTests/BridgePaneControllerTests"
run_webkit_suite_with_retry "WebKitSerializedTests/BridgeSchemeHandlerSpikeTests"
run_webkit_suite_with_retry "WebKitSerializedTests/BridgeTransportIntegrationTests"
run_webkit_suite_with_retry "WebKitSerializedTests/BridgeWebKitSpikeTests"

echo "--- E2E serialized tests (serial, coverage) ---"
if [ "${SWIFT_TEST_INCLUDE_E2E:-0}" = "1" ]; then
  run_swift_with_timeout \
    "E2ESerializedTests (coverage)" \
    "$TIMEOUT_SECONDS" \
    env AGENT_STUDIO_BENCHMARK_MODE=off swift test --enable-code-coverage --filter E2ESerializedTests --build-path "$BUILD_PATH"
else
  echo "[test-coverage] skipping E2ESerializedTests (SWIFT_TEST_INCLUDE_E2E=${SWIFT_TEST_INCLUDE_E2E:-0})"
fi

echo "--- Zmx E2E tests (serial, coverage) ---"
if [ "${SWIFT_TEST_INCLUDE_ZMX_E2E:-0}" = "1" ]; then
  run_swift_with_timeout \
    "ZmxE2ETests (coverage)" \
    "$TIMEOUT_SECONDS" \
    env AGENT_STUDIO_BENCHMARK_MODE=off swift test --enable-code-coverage --filter ZmxE2ETests --build-path "$BUILD_PATH"
else
  echo "[test-coverage] skipping ZmxE2ETests (SWIFT_TEST_INCLUDE_ZMX_E2E=${SWIFT_TEST_INCLUDE_ZMX_E2E:-0})"
fi

COVERAGE_JSON_PATH=$(perl -e 'alarm shift; exec @ARGV' "$TIMEOUT_SECONDS" swift test --show-codecov-path --build-path "$BUILD_PATH")
echo "[coverage] JSON: $COVERAGE_JSON_PATH"
if [ -f "$COVERAGE_JSON_PATH" ] && command -v jq >/dev/null 2>&1; then
  LINES_PERCENT=$(jq -r '.data[0].totals.lines.percent // empty' "$COVERAGE_JSON_PATH" || true)
  FUNCTIONS_PERCENT=$(jq -r '.data[0].totals.functions.percent // empty' "$COVERAGE_JSON_PATH" || true)
  REGIONS_PERCENT=$(jq -r '.data[0].totals.regions.percent // empty' "$COVERAGE_JSON_PATH" || true)
  if [ -n "$LINES_PERCENT" ]; then
    echo "[coverage] lines=%$LINES_PERCENT functions=%$FUNCTIONS_PERCENT regions=%$REGIONS_PERCENT"
  fi
fi
"""

[tasks.test-e2e]
description = "Run E2E serialized tests only (opt-in; zmx E2E currently unstable)"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -euo pipefail
BUILD_PATH="${SWIFT_BUILD_DIR:-.build}"
AGENT_STUDIO_BENCHMARK_MODE=off swift test --filter E2ESerializedTests --build-path "$BUILD_PATH"
"""

[tasks.test-zmx-e2e]
description = "Run zmx E2E tests only (opt-in; may stall)"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -euo pipefail
BUILD_PATH="${SWIFT_BUILD_DIR:-.build}"
AGENT_STUDIO_BENCHMARK_MODE=off swift test --filter ZmxE2ETests --build-path "$BUILD_PATH"
"""

[tasks.test-benchmark]
description = "Run benchmark-only bridge push tests"
depends = ["build"]
run = """
#!/usr/bin/env bash
set -euo pipefail
BUILD_PATH="${SWIFT_BUILD_DIR:-.build}"
export AGENT_STUDIO_BENCHMARK_MODE=benchmark

swift test --build-path "$BUILD_PATH" --filter "PushBenchmarkSupportTests"
swift test --build-path "$BUILD_PATH" --filter "PushPerformanceBenchmarkTests"
"""

[tasks.clean]
description = "Clean all build artifacts"
run = """
rm -rf .build Frameworks/GhosttyKit.xcframework AgentStudio.app
rm -rf Sources/AgentStudio/Resources/ghostty
rm -rf vendor/ghostty/.zig-cache vendor/ghostty/zig-out vendor/ghostty/macos/build vendor/ghostty/macos/*.xcframework
rm -rf vendor/zmx/.zig-cache vendor/zmx/zig-out
echo "Cleaned all build artifacts"
"""

[tasks.create-app-bundle]
description = "Create signed AgentStudio.app bundle"
depends = ["build-release"]
run = """
#!/usr/bin/env bash
set -e

APP_DIR="AgentStudio.app/Contents"
rm -rf AgentStudio.app
mkdir -p "$APP_DIR/MacOS" "$APP_DIR/Resources" "$APP_DIR/Frameworks"

# Binary
cp .build/release/AgentStudio "$APP_DIR/MacOS/"

# zmx
[ -f "vendor/zmx/zig-out/bin/zmx" ] && cp vendor/zmx/zig-out/bin/zmx "$APP_DIR/MacOS/"

# Info.plist + icon
cp Sources/AgentStudio/Resources/Info.plist "$APP_DIR/"
cp Sources/AgentStudio/Resources/AppIcon.icns "$APP_DIR/Resources/"

# terminfo
TERMINFO="Sources/AgentStudio/Resources/terminfo"
[ -d "$TERMINFO" ] && cp -R "$TERMINFO" "$APP_DIR/Resources/"

# shell-integration
GHOSTTY_RES="Sources/AgentStudio/Resources/ghostty"
[ -d "$GHOSTTY_RES" ] && { mkdir -p "$APP_DIR/Resources/ghostty"; cp -R "$GHOSTTY_RES/." "$APP_DIR/Resources/ghostty/"; }

# GhosttyKit framework
cp -R Frameworks/GhosttyKit.xcframework "$APP_DIR/Frameworks/"

# Sign
codesign --force --deep --sign - AgentStudio.app
echo "AgentStudio.app created and signed"
"""
