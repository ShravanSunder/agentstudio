name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup mise
        uses: jdx/mise-action@v3

      # --- Lint (fast, no build needed) ---

      - name: Install lint tools
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALL_CLEANUP: 1
        run: brew install swift-format swiftlint

      - name: Lint + boundary checks
        run: mise run lint

      - name: Format check (swift-format)
        run: |
          swift-format format --in-place --recursive Sources/ Tests/
          git diff --quiet -- Sources/ Tests/ || {
            echo "Swift formatting changes detected. Run mise run format locally.";
            git diff -- Sources/ Tests/;
            exit 1;
          }

      # --- Submodule SHAs for cache keys ---

      - name: Get submodule SHAs
        id: submodules
        run: |
          GHOSTTY_SHA=$(git -C vendor/ghostty rev-parse HEAD)
          ZMX_SHA=$(git -C vendor/zmx rev-parse HEAD)
          echo "ghostty_sha=$GHOSTTY_SHA" >> "$GITHUB_OUTPUT"
          echo "zmx_sha=$ZMX_SHA" >> "$GITHUB_OUTPUT"

      # --- Cache/build Ghostty ---

      - name: Cache Ghostty artifacts
        id: cache-ghostty
        uses: actions/cache@v4
        with:
          path: |
            vendor/ghostty/macos/GhosttyKit.xcframework
            vendor/ghostty/zig-out/share
          key: ghostty-${{ runner.os }}-${{ steps.submodules.outputs.ghostty_sha }}

      - name: Build Ghostty XCFramework
        if: steps.cache-ghostty.outputs.cache-hit != 'true'
        run: |
          cd vendor/ghostty
          zig build -Doptimize=ReleaseFast -Demit-xcframework=true -Demit-macos-app=false -Dxcframework-target=native

      # --- Cache/build zmx ---

      - name: Cache zmx artifacts
        id: cache-zmx
        uses: actions/cache@v4
        with:
          path: vendor/zmx/zig-out
          key: zmx-${{ runner.os }}-${{ steps.submodules.outputs.zmx_sha }}

      - name: Build zmx
        if: steps.cache-zmx.outputs.cache-hit != 'true'
        run: |
          cd vendor/zmx
          zig build -Doptimize=ReleaseFast

      # --- Setup resources + build + test (delegated to mise) ---

      - name: Copy XCFramework
        run: |
          mkdir -p Frameworks
          if [ ! -d "Frameworks/GhosttyKit.xcframework" ]; then
            cp -R vendor/ghostty/macos/GhosttyKit.xcframework Frameworks/
          fi

      - name: Setup dev resources
        run: |
          SHELL_SRC="vendor/ghostty/zig-out/share/ghostty/shell-integration"
          SHELL_DST="Sources/AgentStudio/Resources/ghostty/shell-integration"
          if [ ! -d "$SHELL_DST" ]; then
            mkdir -p "$(dirname "$SHELL_DST")"
            cp -R "$SHELL_SRC" "$SHELL_DST"
          fi
          TERMINFO_SRC="vendor/ghostty/zig-out/share/terminfo"
          TERMINFO_DST="Sources/AgentStudio/Resources/terminfo"
          if [ ! -d "$TERMINFO_DST/78" ]; then
            mkdir -p "$TERMINFO_DST/78" "$TERMINFO_DST/67"
            [ -f "$TERMINFO_SRC/78/xterm-ghostty" ] && cp "$TERMINFO_SRC/78/xterm-ghostty" "$TERMINFO_DST/78/"
            [ -f "$TERMINFO_SRC/67/ghostty" ] && cp "$TERMINFO_SRC/67/ghostty" "$TERMINFO_DST/67/"
          fi

      - name: Cache Swift build
        uses: actions/cache@v4
        with:
          path: .build
          key: swift-${{ runner.os }}-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            swift-${{ runner.os }}-

      - name: Build
        run: mise run build-release

      - name: Test
        env:
          SWIFT_TEST_WORKERS: "8"
        run: mise run test

      - name: Benchmark tests
        run: |
          mise run test-benchmark 2>&1 | tee benchmark.log
          grep -E "\[PushBenchmark\]" benchmark.log > benchmark-lines.txt || true
          if [ ! -s benchmark-lines.txt ]; then
            echo "[PushBenchmark] No benchmark threshold lines emitted in this run." > benchmark-lines.txt
          fi
          echo "Benchmark summary:"
          cat benchmark-lines.txt

      - name: Build benchmark PR comment body
        if: github.event_name == 'pull_request' && always()
        run: |
          {
            echo "<!-- benchmark-lane-report -->"
            echo "## Benchmark lane (\`test-benchmark\`)"
            echo ""
            echo "- Workflow run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            echo "- Commit: \`${{ github.sha }}\`"
            echo "- Result: \`${{ job.status }}\`"
            echo ""
            echo "### PushBenchmark lines"
            echo ""
            echo '```text'
            if [ -f benchmark-lines.txt ]; then
              cat benchmark-lines.txt
            else
              echo "[PushBenchmark] benchmark-lines.txt missing (benchmark step did not run or failed early)."
            fi
            echo '```'
          } > benchmark-comment.md

      - name: Update benchmark PR comment
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const marker = '<!-- benchmark-lane-report -->';
            const body = fs.existsSync('benchmark-comment.md')
              ? fs.readFileSync('benchmark-comment.md', 'utf8')
              : `${marker}\n## Benchmark lane (\`test-benchmark\`)\n\n- Workflow run: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n- Commit: \`${context.sha}\`\n- Result: \`${process.env.JOB_STATUS ?? 'unknown'}\`\n\n### PushBenchmark lines\n\n\`\`\`text\n[PushBenchmark] benchmark-comment.md missing (comment body step failed unexpectedly).\n\`\`\``;
            const issue_number = context.issue.number;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find((comment) =>
              comment.user?.type === 'Bot' &&
              typeof comment.body === 'string' &&
              comment.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number,
                body,
              });
            }
