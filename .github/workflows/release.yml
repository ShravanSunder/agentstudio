name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-26

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup mise
        uses: jdx/mise-action@v3

      # --- Submodule commit SHAs (cache keys) ---

      - name: Get submodule SHAs
        id: submodules
        run: |
          GHOSTTY_SHA=$(git -C vendor/ghostty rev-parse HEAD)
          ZMX_SHA=$(git -C vendor/zmx rev-parse HEAD)
          echo "ghostty_sha=$GHOSTTY_SHA" >> "$GITHUB_OUTPUT"
          echo "zmx_sha=$ZMX_SHA" >> "$GITHUB_OUTPUT"
          echo "Ghostty: $GHOSTTY_SHA"
          echo "zmx: $ZMX_SHA"

      # --- Artifact caches (skip zig builds on hit) ---

      - name: Cache Ghostty artifacts
        id: cache-ghostty
        uses: actions/cache@v4
        with:
          path: |
            vendor/ghostty/macos/GhosttyKit.xcframework
            vendor/ghostty/zig-out/share
          key: ghostty-${{ runner.os }}-${{ steps.submodules.outputs.ghostty_sha }}

      - name: Cache zmx artifacts
        id: cache-zmx
        uses: actions/cache@v4
        with:
          path: vendor/zmx/zig-out
          key: zmx-${{ runner.os }}-${{ steps.submodules.outputs.zmx_sha }}

      # --- Zig compilation cache (speeds up builds on cache miss) ---
      # Following Ghostty's pattern: explicit cache dirs for zig internals

      - name: Cache Zig compilation
        if: steps.cache-ghostty.outputs.cache-hit != 'true' || steps.cache-zmx.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/zig
            vendor/ghostty/.zig-cache
            vendor/zmx/.zig-cache
          key: zig-compile-${{ runner.os }}-${{ hashFiles('.mise.toml') }}-${{ steps.submodules.outputs.ghostty_sha }}-${{ steps.submodules.outputs.zmx_sha }}
          restore-keys: |
            zig-compile-${{ runner.os }}-${{ hashFiles('.mise.toml') }}-

      # --- Build Ghostty (only on cache miss) ---

      - name: Build Ghostty XCFramework
        if: steps.cache-ghostty.outputs.cache-hit != 'true'
        run: |
          cd vendor/ghostty
          zig build -Doptimize=ReleaseFast -Demit-xcframework=true -Demit-macos-app=false -Dxcframework-target=native

      # --- Build zmx (only on cache miss) ---

      - name: Build zmx
        if: steps.cache-zmx.outputs.cache-hit != 'true'
        run: |
          cd vendor/zmx
          zig build -Doptimize=ReleaseFast

      # --- Always: copy framework, setup resources, build Swift, bundle ---

      - name: Copy XCFramework
        run: |
          mkdir -p Frameworks
          cp -R vendor/ghostty/macos/GhosttyKit.xcframework Frameworks/

      - name: Setup dev resources
        run: |
          # Shell integration (prefer zig-out, fall back to vendor source)
          if [ -d "vendor/ghostty/zig-out/share/ghostty/shell-integration" ]; then
            SRC="vendor/ghostty/zig-out/share/ghostty/shell-integration"
          elif [ -d "vendor/ghostty/src/shell-integration" ]; then
            SRC="vendor/ghostty/src/shell-integration"
          else
            echo "ERROR: shell-integration not found" && exit 1
          fi
          mkdir -p Sources/AgentStudio/Resources/ghostty
          rm -rf Sources/AgentStudio/Resources/ghostty/shell-integration
          cp -R "$SRC" Sources/AgentStudio/Resources/ghostty/shell-integration

          # Terminfo
          TERMINFO_SRC="vendor/ghostty/zig-out/share/terminfo"
          if [ -d "$TERMINFO_SRC" ]; then
            mkdir -p Sources/AgentStudio/Resources/terminfo/78 Sources/AgentStudio/Resources/terminfo/67
            [ -f "$TERMINFO_SRC/78/xterm-ghostty" ] && cp "$TERMINFO_SRC/78/xterm-ghostty" Sources/AgentStudio/Resources/terminfo/78/
            [ -f "$TERMINFO_SRC/67/ghostty" ] && cp "$TERMINFO_SRC/67/ghostty" Sources/AgentStudio/Resources/terminfo/67/
          fi

      - name: Cache Swift build
        uses: actions/cache@v4
        with:
          path: .build
          key: swift-${{ runner.os }}-${{ hashFiles('Package.swift', 'Package.resolved') }}
          restore-keys: |
            swift-${{ runner.os }}-

      - name: Build AgentStudio
        run: |
          set -o pipefail
          swift build -c release 2>&1 | scripts/filter-known-linker-warnings.sh

      - name: Create App Bundle
        run: |
          APP_DIR="AgentStudio.app/Contents"
          rm -rf AgentStudio.app
          mkdir -p "$APP_DIR/MacOS" "$APP_DIR/Resources" "$APP_DIR/Frameworks"

          cp .build/release/AgentStudio "$APP_DIR/MacOS/"
          [ -f "vendor/zmx/zig-out/bin/zmx" ] && cp vendor/zmx/zig-out/bin/zmx "$APP_DIR/MacOS/"
          cp Sources/AgentStudio/Resources/Info.plist "$APP_DIR/"
          cp Sources/AgentStudio/Resources/AppIcon.icns "$APP_DIR/Resources/"
          [ -d "Sources/AgentStudio/Resources/terminfo" ] && cp -R Sources/AgentStudio/Resources/terminfo "$APP_DIR/Resources/"
          if [ -d "Sources/AgentStudio/Resources/ghostty" ]; then
            mkdir -p "$APP_DIR/Resources/ghostty"
            cp -R Sources/AgentStudio/Resources/ghostty/. "$APP_DIR/Resources/ghostty/"
          fi
          cp -R Frameworks/GhosttyKit.xcframework "$APP_DIR/Frameworks/"

          codesign --force --deep --sign - AgentStudio.app
          echo "AgentStudio.app created and signed"

      - name: Create ZIP Archive
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          zip -r "AgentStudio-${VERSION}-macos.zip" AgentStudio.app
          echo "ARTIFACT_NAME=AgentStudio-${VERSION}-macos.zip" >> $GITHUB_ENV

      - name: Compute SHA256
        run: |
          SHA256=$(shasum -a 256 "${{ env.ARTIFACT_NAME }}" | awk '{print $1}')
          echo "SHA256: $SHA256"
          echo "RELEASE_SHA256=$SHA256" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ARTIFACT_NAME }}
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
          body: |
            **SHA256:** `${{ env.RELEASE_SHA256 }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
